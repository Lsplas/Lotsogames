<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DOOR 100: GRAND LIBRARY</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Courier New', monospace; user-select: none; }
        
        /* UI OVERLAY */
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        /* TOP HUD */
        #hud-top { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        #objective { color: #00ffff; font-size: 28px; font-weight: bold; background: rgba(0,0,0,0.7); padding: 15px; border: 2px solid #00aaaa; border-radius: 8px; box-shadow: 0 0 15px #00aaaa; }
        #warning { color: red; font-size: 24px; font-weight: bold; opacity: 0; transition: opacity 0.5s; text-shadow: 0 0 10px red; background: black; padding: 5px; }

        /* CENTER */
        #center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; }
        #crosshair { width: 8px; height: 8px; background: white; border-radius: 50%; box-shadow: 0 0 4px white; }
        #interact { margin-top: 20px; color: white; font-size: 20px; font-weight: bold; text-shadow: 0 0 5px black; opacity: 0; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; }

        /* BOTTOM RIGHT */
        #posture { position: absolute; bottom: 20px; right: 20px; font-size: 50px; text-shadow: 0 0 10px black; }

        /* SCREENS */
        #start-screen, #game-over {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10,10,10,0.95); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        #game-over { display: none; z-index: 200; background: #220000; }
        
        h1 { font-size: 60px; color: #fbbf24; margin: 0; text-shadow: 0 0 20px orange; }
        p { font-size: 20px; color: #ccc; max-width: 600px; text-align: center; line-height: 1.5; }
        button { margin-top: 30px; padding: 15px 40px; font-size: 24px; background: #fbbf24; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; transition: 0.2s; }
        button:hover { transform: scale(1.05); background: white; }

        /* JUMPSCARE FACE */
        #scare { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 150; display: none; align-items: center; justify-content: center; }
        #scare-img { width: 90%; height: 90%; background: radial-gradient(circle, red, black); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 150px; color: black; animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(0,0); } }

    </style>
</head>
<body>

    <div id="start-screen">
        <h1>THE GRAND LIBRARY</h1>
        <p>The Figure patrols this room.</p>
        <p>1. Crouch (<b>C</b>) to stay quiet.<br>
           2. If you run, he <b>WILL</b> hear you.<br>
           3. Collect <b>30 Fuses</b> to power the elevator.</p>
        <button id="start-btn">ENTER</button>
    </div>

    <div id="scare"><div id="scare-img">üëÅÔ∏èüëÑüëÅÔ∏è</div></div>

    <div id="game-over">
        <h1 style="color: red;">YOU DIED</h1>
        <p id="death-msg">The Figure heard you running.</p>
        <button onclick="location.reload()">TRY AGAIN</button>
    </div>

    <div id="ui">
        <div id="hud-top">
            <div id="objective">FUSES: 0 / 30</div>
            <div id="warning">‚ö† HE HEARS YOU! ‚ö†</div>
        </div>
        <div id="center">
            <div id="crosshair"></div>
            <div id="interact">[E] INTERACT</div>
        </div>
        <div id="posture">üèÉ</div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'fuse') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now+0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
                osc.start(now); osc.stop(now+0.1);
            } else if (type === 'scream') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(1000, now+0.5);
                gain.gain.setValueAtTime(0.5, now); gain.gain.linearRampToValueAtTime(0, now+1.0);
                osc.start(now); osc.stop(now+1.0);
            } else if (type === 'alert') {
                osc.type = 'square'; osc.frequency.setValueAtTime(100, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
                osc.start(now); osc.stop(now+0.3);
            }
        }

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        scene.fog = new THREE.Fog(0x111111, 10, 40);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
        const renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- LIGHTING ---
        const ambient = new THREE.AmbientLight(0xffffff, 0.3); 
        scene.add(ambient);

        // Warm Library Lights
        function addLight(x, z) {
            const light = new THREE.PointLight(0xffaa55, 0.8, 25);
            light.position.set(x, 7, z);
            light.castShadow = true;
            scene.add(light);
            // Visual bulb
            const mesh = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({color: 0xffaa55}));
            mesh.position.set(x, 7.2, z);
            scene.add(mesh);
        }
        addLight(0, 0);
        addLight(-15, -15);
        addLight(15, 15);
        addLight(-15, 15);
        addLight(15, -15);

        // --- LEVEL GENERATION ---
        const interactables = [];
        const obstacles = [];

        function createLevel() {
            // Floor (Carpet)
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(60, 60), new THREE.MeshStandardMaterial({color: 0x553311, roughness: 0.8}));
            floor.rotation.x = -Math.PI/2;
            floor.receiveShadow = true;
            scene.add(floor);

            // Ceiling
            const ceil = new THREE.Mesh(new THREE.PlaneGeometry(60, 60), new THREE.MeshStandardMaterial({color: 0x222222}));
            ceil.rotation.x = Math.PI/2;
            ceil.position.y = 8;
            scene.add(ceil);

            // Walls
            const wallMat = new THREE.MeshStandardMaterial({color: 0x443322});
            const addWall = (w, h, d, x, z) => {
                const wall = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), wallMat);
                wall.position.set(x, h/2, z);
                scene.add(wall);
                obstacles.push(wall);
            };
            addWall(60, 8, 1, 0, -30); // Back
            addWall(60, 8, 1, 0, 30);  // Front
            addWall(1, 8, 60, -30, 0); // Left
            addWall(1, 8, 60, 30, 0);  // Right

            // SHELVES (The "Maze")
            const shelfGeo = new THREE.BoxGeometry(2, 6, 8);
            const shelfMat = new THREE.MeshStandardMaterial({color: 0x3d2817});

            for(let i=0; i<16; i++) {
                const x = (Math.random()-0.5) * 40;
                const z = (Math.random()-0.5) * 40;
                // Keep center and start area semi-clear
                if(Math.abs(x) < 5 && Math.abs(z) < 5) continue; 
                if(z > 20) continue; // Keep space near door

                const shelf = new THREE.Mesh(shelfGeo, shelfMat);
                shelf.position.set(x, 3, z);
                shelf.rotation.y = Math.random() > 0.5 ? 0 : Math.PI/2;
                shelf.castShadow = true;
                shelf.receiveShadow = true;
                scene.add(shelf);
                obstacles.push(shelf);
            }

            // BREAKER BOX
            const box = new THREE.Mesh(new THREE.BoxGeometry(3, 3, 1), new THREE.MeshStandardMaterial({color: 0x333333}));
            box.position.set(0, 3, -29.5);
            box.userData = { type: 'box' };
            interactables.push(box);
            scene.add(box);

            // 30 FUSES
            for(let i=0; i<30; i++) {
                const fuse = new THREE.Group();
                // Glowy neon cylinder
                const m = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.1, 0.1, 0.6), 
                    new THREE.MeshBasicMaterial({color: 0x00ffff})
                );
                m.rotation.z = Math.PI/2;
                const light = new THREE.PointLight(0x00ffff, 0.5, 3);
                fuse.add(m, light);
                
                // Random position (on shelves or floor)
                fuse.position.set(
                    (Math.random()-0.5) * 50,
                    0.5 + Math.random() * 2, // Varied height
                    (Math.random()-0.5) * 50
                );
                
                fuse.userData = { type: 'fuse' };
                scene.add(fuse);
                interactables.push(fuse);
            }
        }

        // --- THE FIGURE (FULL BODY MODEL) ---
        const figure = new THREE.Group();
        
        function createFigure() {
            const skin = new THREE.MeshStandardMaterial({color: 0x882222, roughness: 0.4});

            // 1. LEGS
            const legGeo = new THREE.CylinderGeometry(0.15, 0.15, 1.2);
            const legL = new THREE.Mesh(legGeo, skin); legL.position.set(-0.25, 0.6, 0);
            const legR = new THREE.Mesh(legGeo, skin); legR.position.set(0.25, 0.6, 0);
            figure.add(legL, legR);

            // 2. TORSO
            const torso = new THREE.Mesh(new THREE.CylinderGeometry(0.35, 0.25, 1.0), skin);
            torso.position.set(0, 1.7, 0);
            figure.add(torso);

            // 3. ARMS (Long)
            const armGeo = new THREE.CylinderGeometry(0.1, 0.1, 1.4);
            const armL = new THREE.Mesh(armGeo, skin); 
            armL.position.set(-0.5, 1.8, 0.2); armL.rotation.z = 0.2; armL.rotation.x = -0.5;
            const armR = new THREE.Mesh(armGeo, skin); 
            armR.position.set(0.5, 1.8, 0.2); armR.rotation.z = -0.2; armR.rotation.x = -0.5;
            figure.add(armL, armR);

            // 4. HEAD
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.4), skin);
            head.position.set(0, 2.4, 0);
            
            // Mouth
            const mouth = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.2, 0.4), new THREE.MeshBasicMaterial({color:0x000000}));
            mouth.position.set(0, 0, 0.2);
            head.add(mouth);

            // Teeth
            for(let i=0; i<8; i++) {
                const tooth = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.08, 0.05), new THREE.MeshBasicMaterial({color: 0xffffff}));
                tooth.position.set((i-3.5)*0.06, 0.05, 0.22);
                head.add(tooth);
                const toothB = tooth.clone();
                toothB.position.y = -0.05;
                head.add(toothB);
            }

            figure.add(head);
            scene.add(figure);
            figure.position.set(0, 0, -10);
        }

        // --- GAME LOGIC ---
        const controls = new PointerLockControls(camera, document.body);
        const player = new THREE.Group();
        player.add(camera);
        scene.add(player);
        player.position.set(0, 1.7, 28); // Start at front

        const state = {
            fuses: 0,
            dead: false,
            crouching: false,
            figureState: 'PATROL',
            figureTarget: new THREE.Vector3(0,0,0)
        };

        const keys = { w:0, a:0, s:0, d:0 };

        document.getElementById('start-btn').onclick = () => {
            document.getElementById('start-screen').style.display = 'none';
            controls.lock();
            createLevel();
            createFigure();
        };

        document.addEventListener('keydown', e => {
            if(e.code === 'KeyW') keys.w = 1;
            if(e.code === 'KeyA') keys.a = 1;
            if(e.code === 'KeyS') keys.s = 1;
            if(e.code === 'KeyD') keys.d = 1;
            if(e.code === 'KeyC') {
                state.crouching = true;
                player.position.y = 0.9; // Crouch height
                document.getElementById('posture').innerText = 'üßé';
            }
            if(e.code === 'KeyE') interact();
        });

        document.addEventListener('keyup', e => {
            if(e.code === 'KeyW') keys.w = 0;
            if(e.code === 'KeyA') keys.a = 0;
            if(e.code === 'KeyS') keys.s = 0;
            if(e.code === 'KeyD') keys.d = 0;
            if(e.code === 'KeyC') {
                state.crouching = false;
                player.position.y = 1.7; // Stand height
                document.getElementById('posture').innerText = 'üèÉ';
            }
        });

        // --- FIGURE AI (SLOWER & SMARTER) ---
        function updateFigure(dt) {
            if(state.dead) return;

            const pos = figure.position;
            const dist = pos.distanceTo(player.position);
            const isMoving = (keys.w || keys.a || keys.s || keys.d);

            // 1. HEARING (Instant trigger if running)
            if (isMoving && !state.crouching) {
                if(state.figureState !== 'CHASE') {
                    state.figureState = 'CHASE';
                    playSound('alert');
                    document.getElementById('warning').style.opacity = 1;
                }
                // Update target to player constantly if they are loud
                state.figureTarget.copy(player.position);
            } else {
                document.getElementById('warning').style.opacity = 0;
                // If chasing but player hides (crouches), he goes to last known spot then maybe patrol
                if (state.figureState === 'CHASE' && dist < 10) {
                     state.figureTarget.copy(player.position); // Still tracks close range
                } else if (state.figureState === 'CHASE' && dist >= 10) {
                     // Lost interest
                     if(Math.random() < 0.02) state.figureState = 'PATROL';
                }
            }

            // 2. MOVEMENT SPEEDS (Adjusted as requested: "Not so fast")
            // Player Run: 7.0, Player Crouch: 3.0
            // Figure Patrol: 3.0 (Slow walk)
            // Figure Chase: 6.5 (Scary but outrunnable if sprinting)
            const speed = state.figureState === 'CHASE' ? 6.5 : 3.0;

            // Patrol Logic
            if(state.figureState === 'PATROL') {
                if(pos.distanceTo(state.figureTarget) < 1) {
                    state.figureTarget.set(
                        (Math.random()-0.5)*50,
                        0,
                        (Math.random()-0.5)*50
                    );
                }
            }

            // Move
            const dir = new THREE.Vector3().subVectors(state.figureTarget, pos).normalize();
            dir.y = 0;
            
            // Simple obstruction avoidance
            obstacles.forEach(ob => {
                if(pos.distanceTo(ob.position) < 3.5) {
                    const push = new THREE.Vector3().subVectors(pos, ob.position).normalize();
                    dir.add(push.multiplyScalar(1.5));
                }
            });
            dir.normalize();

            pos.addScaledVector(dir, speed * dt);
            figure.lookAt(state.figureTarget.x, 2, state.figureTarget.z);

            // Bobbing animation
            figure.position.y = Math.sin(Date.now() * 0.005) * 0.1;

            // 3. JUMPSCARE
            if(dist < 1.3) {
                killPlayer();
            }
        }

        function killPlayer() {
            state.dead = true;
            document.exitPointerLock();
            playSound('scream');
            
            // Show Scare Face
            document.getElementById('scare').style.display = 'flex';
            
            setTimeout(() => {
                document.getElementById('scare').style.display = 'none';
                document.getElementById('game-over').style.display = 'flex';
                document.getElementById('death-msg').innerText = "He caught you. Remember to CROUCH.";
            }, 1500);
        }

        // --- INTERACTION ---
        const raycaster = new THREE.Raycaster();
        function interact() {
            if(state.dead) return;
            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = raycaster.intersectObjects(interactables, true);
            
            if(hits.length > 0 && hits[0].distance < 3) {
                let obj = hits[0].object;
                while(!obj.userData.type && obj.parent) obj = obj.parent;
                
                if(obj.userData.type === 'fuse') {
                    state.fuses++;
                    playSound('fuse');
                    // Hide fuse
                    obj.position.y = -50;
                    document.getElementById('objective').innerText = `FUSES: ${state.fuses} / 30`;
                }
                else if(obj.userData.type === 'box') {
                    if(state.fuses >= 30) {
                        alert("YOU RESTORED THE POWER! ESCAPE SUCCESSFUL!");
                        location.reload();
                    } else {
                        // Locked visual
                        document.getElementById('objective').style.color = 'red';
                        setTimeout(() => document.getElementById('objective').style.color = 'cyan', 200);
                    }
                }
            }
        }

        // --- MAIN LOOP ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            if(controls.isLocked && !state.dead) {
                // Player Move
                let moveSpeed = state.crouching ? 3.0 : 7.0; // Crouch vs Run
                
                const dir = new THREE.Vector3();
                const fwd = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion); fwd.y=0; fwd.normalize();
                const right = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion); right.y=0; right.normalize();
                
                if(keys.w) dir.add(fwd); if(keys.s) dir.sub(fwd);
                if(keys.a) dir.sub(right); if(keys.d) dir.add(right);
                
                if(dir.length() > 0) {
                    dir.normalize();
                    player.position.addScaledVector(dir, moveSpeed * dt);
                }
            }

            if(figure.parent) updateFigure(dt);

            // Fuse rotation
            interactables.forEach(i => {
                if(i.userData.type === 'fuse') {
                    i.rotation.y += dt;
                }
            });

            // Interaction UI
            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = raycaster.intersectObjects(interactables, true);
            const prompt = document.getElementById('interact');
            if(hits.length > 0 && hits[0].distance < 3) {
                prompt.style.opacity = 1;
                let t = hits[0].object.userData.type || hits[0].object.parent.userData.type;
                prompt.innerText = t === 'fuse' ? "[E] TAKE FUSE" : (state.fuses>=30 ? "[E] ACTIVATE" : "[E] LOCKED");
            } else {
                prompt.style.opacity = 0;
            }

            renderer.render(scene, camera);
        }
        animate();

        window.onresize = () => { camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); };
    </script>
</body>
</html>
