<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ultimate Obby v7: Animated Character</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; user-select: none; }
        
        /* UI OVERLAYS */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; cursor: pointer;
        }
        
        /* HEADS UP DISPLAY */
        #ui {
            position: absolute; top: 20px; left: 20px; color: white; font-weight: bold; 
            text-shadow: 2px 2px 0 #000; pointer-events: none; font-size: 24px;
        }

        /* CROSSHAIR */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            background: transparent; border: 2px solid rgba(255,255,255,0.8);
            border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none;
        }

        /* INVENTORY */
        #inventory {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; pointer-events: none;
        }
        .slot {
            width: 50px; height: 50px; background: rgba(0,0,0,0.5); border: 2px solid #555;
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            color: gold; font-size: 24px; opacity: 0.3; transition: 0.3s;
        }
        .slot.active { opacity: 1; border-color: gold; background: rgba(255, 215, 0, 0.2); box-shadow: 0 0 15px gold; }

        /* MOBILE CONTROLS (Hidden on PC) */
        #mobile-stick {
            position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px;
            background: rgba(255,255,255,0.1); border-radius: 50%; display: none;
        }
        #mobile-jump {
            position: absolute; bottom: 50px; right: 50px; width: 80px; height: 80px;
            background: rgba(255,0,0,0.2); border: 2px solid red; border-radius: 50%; display: none;
        }
        @media (max-width: 1000px) {
            #mobile-stick, #mobile-jump { display: block; }
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-size: 50px; margin: 0; color: #4ade80;">CLICK TO START</h1>
        <p>Mouse to Look • WASD to Move • SPACE to Jump</p>
    </div>

    <div id="ui">
        <div>LEVEL: <span id="level-txt" style="color:#4ade80">1</span></div>
        <div>DEATHS: <span id="death-txt" style="color:#f87171">0</span></div>
    </div>
    <div id="crosshair"></div>
    <div id="inventory">
        <div id="slot-1" class="slot">★</div>
        <div id="slot-2" class="slot">★</div>
        <div id="slot-3" class="slot">★</div>
    </div>

    <div id="mobile-stick"></div>
    <div id="mobile-jump"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- 1. SETUP SCENE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // Sky Blue
        scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

        const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // LIGHTS
        const amb = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(amb);
        const sun = new THREE.DirectionalLight(0xffffff, 1);
        sun.position.set(50, 100, 50);
        sun.castShadow = true;
        sun.shadow.mapSize.width = 2048; 
        sun.shadow.mapSize.height = 2048;
        scene.add(sun);

        // --- 2. THE NEW CHARACTER (Minecraft Style) ---
        const player = new THREE.Group();
        scene.add(player);

        // Materials
        const matSkin = new THREE.MeshStandardMaterial({ color: 0x3b82f6 }); // Blue Body
        const matHead = new THREE.MeshStandardMaterial({ color: 0xffcc00 }); // Yellow Head
        const matLimb = new THREE.MeshStandardMaterial({ color: 0x1e293b }); // Dark Limbs

        // Body Parts
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), matHead);
        head.position.y = 1.6;
        head.castShadow = true;
        player.add(head);

        const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.7, 0.3), matSkin);
        body.position.y = 1.0;
        body.castShadow = true;
        player.add(body);

        // Limbs (Pivot points are important for animation)
        function createLimb(x, y, z) {
            const group = new THREE.Group();
            group.position.set(x, y, z);
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.7, 0.25), matLimb);
            mesh.position.y = -0.35; // Offset so it rotates from top
            mesh.castShadow = true;
            group.add(mesh);
            player.add(group);
            return group;
        }

        const armL = createLimb(-0.45, 1.3, 0);
        const armR = createLimb( 0.45, 1.3, 0);
        const legL = createLimb(-0.2, 0.7, 0);
        const legR = createLimb( 0.2, 0.7, 0);

        // --- 3. WORLD GENERATION ---
        const colliders = [];
        const coins = [];
        
        function createBlock(x, y, z, w, h, d, type) {
            let col = 0xaaaaaa;
            if(type === 'spawn') col = 0x4ade80;
            if(type === 'lava') col = 0xff4444;
            if(type === 'win') col = 0xffd700;
            
            const mesh = new THREE.Mesh(
                new THREE.BoxGeometry(w, h, d),
                new THREE.MeshStandardMaterial({ color: col })
            );
            mesh.position.set(x, y, z);
            
            if(type === 'lava') {
                mesh.material.emissive = 0x990000;
                mesh.material.emissiveIntensity = 0.5;
            } else {
                mesh.receiveShadow = true;
                colliders.push(mesh); // Add to physics (except lava, lava kills instantly)
            }
            
            mesh.userData = { type: type };
            scene.add(mesh);
            return mesh;
        }

        // --- LEVEL DESIGN ---
        createBlock(0, 0, 0, 10, 1, 10, 'spawn');
        
        // Jumps
        createBlock(0, 1, 10, 4, 1, 4, 'base');
        createBlock(0, 2, 18, 4, 1, 4, 'base');
        createBlock(0, 3, 26, 4, 1, 4, 'base');
        
        // Lava Trap
        createBlock(0, 3, 36, 3, 0.5, 10, 'lava'); // Walkable lava (Trap)
        createBlock(0, 3.5, 36, 1, 0.5, 10, 'base'); // Thin safe path

        // Moving Platform (We animate this later)
        const mover = createBlock(0, 4, 50, 6, 1, 6, 'base');

        // Win Area
        createBlock(0, 6, 70, 10, 1, 10, 'win');

        // Giant Lava Floor
        createBlock(0, -10, 50, 200, 1, 200, 'lava');


        // --- 4. GAME ENGINE (Physics & Camera) ---
        let velocityY = 0;
        let onGround = false;
        let spawnPos = new THREE.Vector3(0, 5, 0);
        let deaths = 0;
        
        // Camera Variables
        let camPitch = 0; // Up/Down
        let camYaw = Math.PI;   // Left/Right (Start facing player back)
        const camDist = 8;
        
        const raycaster = new THREE.Raycaster();

        // Inputs
        const keys = { w:0, a:0, s:0, d:0, sp:0 };
        
        // MOUSE LOCK & LOOK
        const startScreen = document.getElementById('start-screen');
        
        startScreen.addEventListener('click', () => {
            document.body.requestPointerLock();
        });

        document.addEventListener('pointerlockchange', () => {
            if(document.pointerLockElement === document.body) {
                startScreen.style.display = 'none';
            } else {
                startScreen.style.display = 'flex';
                document.querySelector('h1').innerText = "PAUSED";
            }
        });

        document.addEventListener('mousemove', (e) => {
            if(document.pointerLockElement === document.body) {
                // Adjust sensitivity here (0.002 is standard)
                camYaw -= e.movementX * 0.002;
                camPitch -= e.movementY * 0.002;
                
                // Limit looking up/down
                camPitch = Math.max(-0.5, Math.min(1.0, camPitch));
            }
        });

        // KEYBOARD
        document.addEventListener('keydown', e => {
            if(e.code === 'KeyW') keys.w = 1;
            if(e.code === 'KeyS') keys.s = 1;
            if(e.code === 'KeyA') keys.a = 1;
            if(e.code === 'KeyD') keys.d = 1;
            if(e.code === 'Space') keys.sp = 1;
            if(e.code === 'KeyR') die();
        });
        document.addEventListener('keyup', e => {
            if(e.code === 'KeyW') keys.w = 0;
            if(e.code === 'KeyS') keys.s = 0;
            if(e.code === 'KeyA') keys.a = 0;
            if(e.code === 'KeyD') keys.d = 0;
            if(e.code === 'Space') keys.sp = 0;
        });

        function die() {
            player.position.copy(spawnPos);
            velocityY = 0;
            deaths++;
            document.getElementById('death-txt').innerText = deaths;
        }

        // --- 5. ANIMATION LOOP ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const dt = Math.min(clock.getDelta(), 0.1);
            const time = Date.now() * 0.001;

            // Animate Level
            mover.position.x = Math.sin(time) * 5; // Platform moves left/right

            // 1. PHYSICS (Gravity)
            velocityY -= 40 * dt;
            
            // 2. MOVEMENT (Camera Relative)
            const speed = 12;
            let isMoving = false;

            // Calculate "Forward" based purely on Camera Angle (camYaw)
            const forwardX = Math.sin(camYaw);
            const forwardZ = Math.cos(camYaw);
            const rightX = Math.sin(camYaw - Math.PI/2);
            const rightZ = Math.cos(camYaw - Math.PI/2);

            const moveX = (keys.w * -forwardX) + (keys.s * forwardX) + (keys.a * -rightX) + (keys.d * rightX);
            const moveZ = (keys.w * -forwardZ) + (keys.s * forwardZ) + (keys.a * -rightZ) + (keys.d * rightZ);

            if (moveX !== 0 || moveZ !== 0) {
                isMoving = true;
                player.position.x += moveX * speed * dt;
                player.position.z += moveZ * speed * dt;
                
                // Rotate character to face movement direction
                player.rotation.y = Math.atan2(moveX, moveZ);
            }

            // 3. COLLISION (Raycasting)
            raycaster.set(player.position.clone().add(new THREE.Vector3(0, 1, 0)), new THREE.Vector3(0, -1, 0));
            const hits = raycaster.intersectObjects(colliders);
            
            onGround = false;
            if (hits.length > 0) {
                const hit = hits[0];
                if (hit.distance < 1.1 && velocityY <= 0) {
                    onGround = true;
                    velocityY = 0;
                    player.position.y = hit.point.y;
                    
                    if (hit.object.userData.type === 'win') {
                        document.getElementById('level-txt').innerText = "WINNER!";
                    }
                }
            }

            // Check Lava (Separate check because lava is not a collider)
            if(player.position.y < -5) die(); 
            
            // Jump
            if (onGround && keys.sp) {
                velocityY = 15;
                onGround = false;
            }
            player.position.y += velocityY * dt;

            // 4. CHARACTER ANIMATION (Walking)
            if(isMoving && onGround) {
                const walkSpeed = 10;
                armL.rotation.x = Math.sin(time * walkSpeed) * 0.5;
                armR.rotation.x = Math.cos(time * walkSpeed) * 0.5;
                legL.rotation.x = Math.cos(time * walkSpeed) * 0.5;
                legR.rotation.x = Math.sin(time * walkSpeed) * 0.5;
            } else {
                // Reset Pose
                armL.rotation.x = armR.rotation.x = legL.rotation.x = legR.rotation.x = 0;
            }

            // 5. CAMERA UPDATE
            // Simple Spherical Coordinates
            const camX = player.position.x + camDist * Math.sin(camYaw) * Math.cos(camPitch);
            const camY = player.position.y + camDist * Math.sin(camPitch) + 2; // +2 looks slightly down
            const camZ = player.position.z + camDist * Math.cos(camYaw) * Math.cos(camPitch);

            camera.position.lerp(new THREE.Vector3(camX, camY, camZ), 0.2);
            camera.lookAt(player.position.clone().add(new THREE.Vector3(0, 1.5, 0))); // Look at head

            renderer.render(scene, camera);
        }
        animate();

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
